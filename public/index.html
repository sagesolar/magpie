<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Magpie Bibliotherapy</title>
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="
      default-src 'self';
      script-src 'self' 'unsafe-inline' https://accounts.google.com;
      style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://accounts.google.com;
      font-src 'self' https://fonts.gstatic.com;
      img-src 'self' data: https:;
      connect-src 'self' https://accounts.google.com https://*.run.app https://localhost:3000;
      frame-src https://accounts.google.com;
    ">
    
    <link rel="manifest" href="manifest.json" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <meta name="theme-color" content="#667eea" />

    <!-- Favicons and Icons -->
    <link rel="icon" type="image/x-icon" href="images/favicons/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicons/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicons/favicon-16x16.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="images/favicons/apple-touch-icon.png" />
    <link rel="mask-icon" href="images/favicons/safari-pinned-tab.svg" color="#667eea" />

    <!-- CSS Files -->
    <link rel="stylesheet" href="styles/main.css" />
    <link rel="stylesheet" href="styles/components.css" />
    <link rel="stylesheet" href="styles/books.css" />
    <link rel="stylesheet" href="styles/forms.css" />
  </head>

  <body>
    <div class="app">
      <!-- Header -->
      <header class="header">
        <div class="header-logo">
          <img src="images/magpie-main.png" alt="Magpie Logo" class="logo-image" />
          <h1>Magpie</h1>
        </div>
        <div class="header-right">
          <p>Your Bibliotherapy</p>
          <!-- Authentication UI -->
          <div class="auth-section" id="authSection">
            <!-- User Profile (shown when logged in) -->
            <div class="user-profile hidden" id="userProfile">
              <img class="user-avatar" id="userAvatar" src="" alt="User Avatar" />
              <div class="user-info">
                <span class="user-name" id="userName"></span>
                <span class="user-email" id="userEmail"></span>
              </div>
              <div class="user-actions">
                <button class="btn btn-secondary btn-small" onclick="app.showUserSettings()">
                  ‚öôÔ∏è Settings
                </button>
                <button class="btn btn-secondary btn-small" onclick="app.logout()">Logout</button>
              </div>
            </div>
            <!-- Login Button (shown when logged out) -->
            <div class="login-section" id="loginSection">
              <button class="btn btn-primary" onclick="app.showLogin()">üîê Sign In</button>
              <p class="offline-note">Continue offline or sign in to sync</p>
            </div>
          </div>
        </div>
      </header>

      <!-- Status Bar -->
      <div class="status-bar">
        <div class="status-indicator">
          <div class="status-dot" id="connectionStatus"></div>
          <span id="connectionText">Online</span>
          <span id="syncStatus"></span>
          <span id="versionInfo" class="version-info"></span>
        </div>
        <button class="sync-button" id="syncButton" onclick="app.manualSync()">üîÑ Sync Now</button>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="app.switchTab('collection')">My Collection</button>
        <button class="tab" onclick="app.switchTab('favourites')">Favourites</button>
        <button class="tab" onclick="app.switchTab('shared')" id="sharedTab">Shared Books</button>
        <button class="tab" onclick="app.switchTab('wishlist')">Wishlist</button>
        <button class="tab" onclick="app.switchTab('loans')">Loans</button>
      </div>

      <!-- Collection Tab -->
      <div id="collection-tab" class="tab-content active">
        <div class="controls">
          <div class="search-bar">
            <input
              type="text"
              class="search-input"
              id="searchInput"
              placeholder="Search books by title, author, or ISBN..."
            />
            <button class="btn btn-primary" onclick="app.searchBooks()">Search</button>
            <button class="btn btn-secondary" onclick="app.showAddBookModal()">+ Add Book</button>
            <button class="btn btn-secondary" onclick="app.showCameraModal()">üì∑ Scan ISBN</button>
          </div>
          <div class="filters">
            <select class="filter-select" id="genreFilter" onchange="app.applyFilters()">
              <option value="">All Genres</option>
            </select>
            <select class="filter-select" id="readFilter" onchange="app.applyFilters()">
              <option value="">All Books</option>
              <option value="true">Read</option>
              <option value="false">Unread</option>
            </select>
            <button class="btn btn-secondary" onclick="app.clearFilters()">Clear Filters</button>
          </div>
        </div>

        <div id="booksContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading your collection...</p>
          </div>
        </div>
      </div>

      <!-- Shared Books Tab -->
      <div id="shared-tab" class="tab-content">
        <div class="auth-required-message" id="sharedAuthMessage">
          <div class="auth-prompt">
            <h3>üìö Shared Collections</h3>
            <p>Sign in to view books shared with you and share your collection with others.</p>
            <button class="btn btn-primary" onclick="app.showLogin()">
              Sign In to View Shared Books
            </button>
          </div>
        </div>
        <div class="shared-content hidden" id="sharedContent">
          <div class="controls">
            <div class="sharing-options">
              <button class="btn btn-secondary" onclick="app.showShareModal()">
                üì§ Share Books
              </button>
              <select class="filter-select" id="sharedFilter" onchange="app.applySharedFilters()">
                <option value="all">All Shared Books</option>
                <option value="shared-with-me">Shared with Me</option>
                <option value="shared-by-me">Shared by Me</option>
              </select>
            </div>
          </div>
          <div id="sharedBooksContainer"></div>
        </div>
      </div>

      <!-- Favourites Tab -->
      <div id="favourites-tab" class="tab-content">
        <div id="favouritesContainer"></div>
      </div>

      <!-- Wishlist Tab -->
      <div id="wishlist-tab" class="tab-content">
        <div class="controls">
          <div class="search-bar">
            <input
              type="text"
              class="search-input"
              id="wishlistSearchInput"
              placeholder="Search for books to add to wishlist..."
            />
            <button class="btn btn-primary" onclick="app.searchWishlist()">Search</button>
          </div>
        </div>
        <div id="wishlistContainer"></div>
      </div>

      <!-- Loans Tab -->
      <div id="loans-tab" class="tab-content">
        <div id="loansContainer"></div>
      </div>
    </div>

    <!-- Add/Edit Book Modal -->
    <div id="bookModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title" id="modalTitle">Add New Book</h2>
          <button class="close-btn" onclick="app.closeModal()">&times;</button>
        </div>
        <form id="bookForm" onsubmit="app.saveBook(event)">
          <div class="form-group">
            <label class="form-label">ISBN *</label>
            <input type="text" class="form-input" id="isbnInput" required />
            <button
              type="button"
              class="btn btn-secondary"
              style="margin-top: 5px"
              onclick="app.fetchBookData()"
            >
              üìñ Fetch Book Data
            </button>
          </div>
          <div class="form-group">
            <label class="form-label">Title *</label>
            <input type="text" class="form-input" id="titleInput" required />
          </div>
          <div class="form-group">
            <label class="form-label">Authors *</label>
            <input
              type="text"
              class="form-input"
              id="authorsInput"
              required
              placeholder="Separate multiple authors with commas"
            />
          </div>
          <div class="form-group">
            <label class="form-label">Publication Date</label>
            <input type="date" class="form-input" id="publicationDateInput" />
          </div>
          <div class="form-group">
            <label class="form-label">Publisher</label>
            <input type="text" class="form-input" id="publisherInput" />
          </div>
          <div class="form-group">
            <label class="form-label">Page Count</label>
            <input type="number" class="form-input" id="pageCountInput" />
          </div>
          <div class="form-group">
            <label class="form-label">Genre</label>
            <input type="text" class="form-input" id="genreInput" />
          </div>
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-input" id="descriptionInput" rows="3"></textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Cover Image URL</label>
            <input type="url" class="form-input" id="coverImageUrlInput" />
          </div>
          <div class="form-group">
            <label class="form-label">Rating (1-5)</label>
            <input type="number" class="form-input" id="ratingInput" min="1" max="5" />
          </div>
          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea class="form-input" id="notesInput" rows="2"></textarea>
          </div>
          <div class="form-group">
            <label> <input type="checkbox" id="isReadInput" /> Mark as read </label>
          </div>
          <div class="form-group">
            <label> <input type="checkbox" id="isFavouriteInput" /> Add to favourites </label>
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px">
            <button type="button" class="btn btn-secondary" onclick="app.closeModal()">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Save Book</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Camera Modal -->
    <div id="cameraModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Scan ISBN with Camera</h2>
          <button class="close-btn" onclick="app.closeCameraModal()">&times;</button>
        </div>
        <div class="camera-container">
          <video id="cameraVideo" class="camera-video" width="400" height="300" autoplay></video>
          <div class="camera-controls">
            <button class="btn btn-primary" id="startScanBtn" onclick="app.startISBNScan()">
              Start Scanning
            </button>
            <button
              class="btn btn-secondary"
              id="stopScanBtn"
              onclick="app.stopISBNScan()"
              style="display: none"
            >
              Stop Scanning
            </button>
          </div>
          <p id="scanStatus" style="margin-top: 10px; color: #6b7280"></p>
        </div>
      </div>
    </div>

    <!-- Loan Modal -->
    <div id="loanModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Loan Book</h2>
          <button class="close-btn" onclick="app.closeLoanModal()">&times;</button>
        </div>
        <form id="loanForm" onsubmit="app.saveLoan(event)">
          <div class="form-group">
            <label class="form-label">Loaned To</label>
            <input type="text" class="form-input" id="loanedToInput" placeholder="Person's name" />
          </div>
          <div class="form-group">
            <label class="form-label">Loan Date</label>
            <input type="date" class="form-input" id="loanDateInput" />
          </div>
          <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px">
            <button type="button" class="btn btn-secondary" onclick="app.closeLoanModal()">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>

    <!-- User Settings Modal -->
    <div id="userSettingsModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">User Settings</h2>
          <button class="close-btn" onclick="app.closeUserSettings()">&times;</button>
        </div>
        <form id="userSettingsForm" onsubmit="app.saveUserSettings(event)">
          <div class="settings-section">
            <h3>Display Preferences</h3>
            <div class="form-group">
              <label class="form-label">Books per page</label>
              <select class="form-input" id="booksPerPageSetting">
                <option value="10">10 books</option>
                <option value="20">20 books</option>
                <option value="50">50 books</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Default view</label>
              <select class="form-input" id="defaultViewSetting">
                <option value="grid">Grid view</option>
                <option value="list">List view</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Sorting style</label>
              <select class="form-input" id="sortingStyleSetting">
                <option value="alphabetical">Alphabetical</option>
                <option value="genre">By genre</option>
                <option value="author">By author</option>
                <option value="date">By date added</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Theme</label>
              <select class="form-input" id="themeSetting">
                <option value="auto">Auto (system)</option>
                <option value="light">Light</option>
                <option value="dark">Dark</option>
              </select>
            </div>
          </div>
          <div class="settings-section">
            <h3>Sharing & Privacy</h3>
            <div class="form-group">
              <label class="form-label">Sharing visibility</label>
              <select class="form-input" id="sharingVisibilitySetting">
                <option value="private">Private (no sharing)</option>
                <option value="friends">Friends only</option>
                <option value="public">Public</option>
              </select>
            </div>
          </div>
          <div class="settings-section">
            <h3>Notifications</h3>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="newBooksNotification" />
                <span>New books added</span>
              </label>
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="loanRemindersNotification" />
                <span>Loan reminders</span>
              </label>
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="sharedCollectionsNotification" />
                <span>Shared collections updates</span>
              </label>
            </div>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="app.closeUserSettings()">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Save Settings</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Share Books Modal -->
    <div id="shareModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 class="modal-title">Share Books</h2>
          <button class="close-btn" onclick="app.closeShareModal()">&times;</button>
        </div>
        <form id="shareForm" onsubmit="app.shareBooks(event)">
          <div class="form-group">
            <label class="form-label">Share with (email addresses)</label>
            <input
              type="text"
              class="form-input"
              id="shareEmailsInput"
              placeholder="email1@example.com, email2@example.com"
              required
            />
            <small>Separate multiple emails with commas</small>
          </div>
          <div class="form-group">
            <label class="form-label">Select books to share</label>
            <div class="book-selection" id="bookSelectionContainer">
              <!-- Books will be populated here -->
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Permissions</label>
            <div class="permission-options">
              <label class="checkbox-label">
                <input type="checkbox" id="canViewPermission" checked disabled />
                <span>Can view books</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="canEditPermission" />
                <span>Can edit book details</span>
              </label>
              <label class="checkbox-label">
                <input type="checkbox" id="canSharePermission" />
                <span>Can share with others</span>
              </label>
            </div>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" onclick="app.closeShareModal()">
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Share Books</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="js/auth.js"></script>
    <script type="module" src="js/db.js"></script>
    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/camera-ocr.js"></script>
    <script type="module" src="js/app.js"></script>

    <script>
      // Register service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker
          .register('/sw.js')
          .then(registration => console.log('SW registered'))
          .catch(error => console.log('SW registration failed'));
      }
    </script>
  </body>
</html>
